<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
    <link rel="stylesheet" href="root.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
          integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
            integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
            crossorigin=""></script>
</head>
<body>

<div id="pathMap"></div>
<br/>
<div id="btn1">ClickMe</div>
<br/>
<br/>
<div id="pwrGraph"></div>
</body>
<script>
	let polyline;

    async function getLatLong(timeBounds) {
        let latLongArr = [];
        await $.getJSON('workout-data.json', function(data) {
        	let lookInto;
        	if(timeBounds){
        		lookInto = data.samples.filter((item) => {
        			//console.log(self);
                  return item.millisecondOffset >= timeBounds[0] && item.millisecondOffset <= timeBounds[1]
                } )
            }else {
			        lookInto = data.samples;
		        }
            for( let key in lookInto ) {
                let latData = lookInto[key].values.positionLat;
                let lonData = lookInto[key].values.positionLong;
                let tmpArr = [];

                //TODO change into a try catch statement
                if(latData && lonData) {
                    tmpArr.push(latData, lonData);
                    latLongArr.push(tmpArr);
                }
            }
            console.log(latLongArr);
            $.each(data.samples, function(i, f){

            })

        });
        return latLongArr;
    }

    getLatLong().then((coordsArr) => {
        let latlongs = coordsArr;

        var pMap = L.map('pathMap').setView([coordsArr[0][0], coordsArr[0][1]], 13);
        polyline = L.polyline(latlongs, {color: 'blue'}).addTo(pMap);
        pMap.fitBounds(polyline.getBounds());
	    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
		    //TODO rewrite this
		    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
		    maxZoom: 18,
		    id: 'mapbox.streets',
		    accessToken: "sk.eyJ1IjoiZ2FycmV0amFtZXMiLCJhIjoiY2pwc25nNW1mMDZxazQybzFmMWZkODh0aiJ9.yaklt83I1FIpv142VljhEg"
	    }).addTo(pMap);
	    $("#btn1").click(function(){alert("hello");
	        pMap.createPane("HighlightPath");
	        polyline.setLatLngs([]);
	    });

console.log(pMap.getPanes());
    });

    let data = [];
    async function getPower() {
	    let pwrTimeArr = [];
	    await $.getJSON('workout-data.json', function(data) {
		    var lookInto = data.samples;

		    for( let key in lookInto ) {
			    let timeOffset = lookInto[key].millisecondOffset;
			    let pwrData = lookInto[key].values.power;
			    let minutes = ((timeOffset / 1000) / 60);
			    //TODO change into a try catch statement
			    if(pwrData) {
				    let tmpObj = {"time": minutes, "power": pwrData}
				    pwrTimeArr.push(tmpObj);
			    }
		    }
		    console.log(pwrTimeArr);
		    $.each(data.samples, function(i, f){

		    })

	    });
	    return pwrTimeArr;
    }
    let xData = [];
    let yData = [];
    getPower().then((pwrTimeArr) => {
	    data = pwrTimeArr;

	    $.each(data, function (index, value) {
		    $.each(value, function (key, value) {
			    key === 'time' ? xData.push(value) : yData.push(value)
		    })
	    })
	    console.log(xData);

	    let trace1 = {
		    x: xData,
		    y: yData,
		    mode: 'lines',
		    name: 'Lines',
		    line: {color: '#777'},
		    marker: {size: 14}
	    }

	    let plotData = [trace1];

	    let layout = {
		    clickmode: 'select',
		    dragmode: 'select',
		    hovermode: 'closest',
		    title: 'Peaks Graph',
		    xaxis: {
			    title: 'Time (minutes)'
		    },
		    yaxis: {
			    title: 'Power'
		    }
	    }
	    let graphDiv = document.getElementById("pwrGraph");
	    Plotly.newPlot(graphDiv, plotData, layout);

	    graphDiv.on('plotly_selected', function (eventData) {
				    console.log(eventData.range.x);
				    let begMilliTime = (eventData.range.x[0] * 60) * 1000;
				    let endMilliTime = (eventData.range.x[1] * 60) * 1000;
				    let milliTime = [begMilliTime, endMilliTime];
				    getLatLong(milliTime).then((latLngArr) =>
					    //console.log(latLngArr));
				    polyline.setLatLngs(latLngArr));
			    }
            )

	    });



    async function getHighestContAvg(timeBounds){
    	let avg2 = 0;
	    await $.getJSON('workout-data.json', function(data) {
		    let lookInto;
		    if(timeBounds){
			    lookInto = data.samples.filter((item) => {
				    //console.log(self);
				    return item.millisecondOffset >= timeBounds[0] && item.millisecondOffset <= timeBounds[1]
			    } )
		    }else {
			    lookInto = data.samples;
		    }
		    let pwrAvg = 0;
		    for( let key in lookInto ) {
			    let pwrData = lookInto[key].values.power;
			    pwrAvg += pwrData;
			    //let lonData = lookInto[key].values.positionLong;
			    //let tmpArr = [];


			    //TODO change into a try catch statement
			    //if(latData && lonData) {
				   // tmpArr.push(latData, lonData);
				   // latLongArr.push(tmpArr);
			    //}
		    }
		    avg2 = pwrAvg/lookInto.length;
		    console.log(avg2);
		    //console.log(latLongArr);
		    $.each(data.samples, function(i, f){

		    })

	    });
	    return avg2;
	    //TODO make recursive function here.
    }

    getHighestContAvg([0,1200000]).then((pwrAvg) => console.log(pwrAvg));

</script>
</html>
